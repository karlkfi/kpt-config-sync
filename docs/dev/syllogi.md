# Syllogi

## Background

Syllogi (GKE On Prem) is a version of GKE that customers can install on their
on-prem VMs. Syllogi comes with the Nomos Operator pre-bundled, meaning that
when users install Syllogi, the nomos-operator is already running, and the
nomos-system namespace exists. You might recognize that as essentially the
`nomos-operator.yaml` artifact deployed
[here](release.md#anatomy-of-a-blessed-release).

# Integration

The Syllogi code is located at
https://gke-internal.git.corp.google.com/syllogi/cluster-management/+/master#

The Nomos integration is currently located in the following places:

*   The version of the operator specified in
    https://gke-internal.git.corp.google.com/syllogi/cluster-management/+/master/gkectl/pkg/bundle/constants.go
    defined by `ClusterOperatorsTag`. This version refers to the Syllogi-managed
    CI flow in Louhi, accessible
    [here](https://gke-release.appspot.com/flow-detail/ag1zfmdrZS1yZWxlYXNlchELEgRGbG93GICAgNCcqocKDA).
    It's called "Cluster-Operators CI" under the flow list, in case the URL
    changes. This build runs daily and pulls the latest code from our usual
    [Operator Repo](https://gke-internal.git.corp.google.com/cluster-lifecycle/cluster-operators/+/master/nomos-operator)

*   The version of the Nomos binary specified in
    https://gke-internal.git.corp.google.com/syllogi/cluster-management/+/master/gkectl/pkg/bundle/versions.go
    defined by gcr.io/%s/Nomos:<version>. This is used by a script that copies
    this binary to a private registry if the customer is using one.

*   The nomos-operator.yaml contents located at
    https://gke-internal.git.corp.google.com/syllogi/cluster-management/+/master/gkectl/pkg/bundle/addonsdata.go
    (under `# Nomos` comment). This is the template for the yamls that get
    deployed with Syllogi by default.

## Release

The Syllogi release of Nomos is the update of that manifest to point to the
latest version of Nomos.

**Note:** We do not need to release Nomos into Syllogi every time we make a
Nomos release. This is an operation that will happen occasionally, when Syllogi
has milestone releases that we want to hop on.

*   Begin by checking out the code `git clone
    sso://gke-internal/syllogi/cluster-management`
*   Examine
    [Louhi](https://gke-release.appspot.com/flow-detail/ag1zfmdrZS1yZWxlYXNlchELEgRGbG93GICAgNCcqocKDA)
    to find the latest built version of the operator. This build must have
    kicked off after we did a [blessing](release.md#nomos-operator) of the
    operator, so normally you should do this on the following day.
*   Edit `gkectl/pkg/bundle/constants.go` and point `ClusterOperatorsTag` to the
    version above.
*   Edit `gkectl/pkg/bundle/versions.go` and update `gcr.io/%s/Nomos:<version>`
    to the latest blessed version of the Nomos binary.
*   Ensure that the contents of `gkectl/pkg/bundle/addonsdata.go` match the
    contents of `nomos-operator.yaml`:
    *   Check out and cd to the
        [Operator repo](https://gke-internal.git.corp.google.com/cluster-lifecycle/cluster-operators/+/master/nomos-operator).
    *   `make ADDONS_FILE=<path-to>/gkectl/pkg/bundle/addonsdata.go
        compare-to-addons-file || echo failed`. This regenerates the nomos
        manifests and searches the supplied `addons.go` for a match.
    *   If `compare-to-addons-file` fails, patch the newly generated nomos
        manifests - located at `.output/nomos-operator-syllogi.yaml` - into
        `addons.go`.

## E2E Test

We also have an end to end test that runs in the syllogi CI. The kick off script
lives in
https://gke-internal.googlesource.com/syllogi/cluster-management/+/master/test-infra/scripts/NomosTest.sh

All the script does is run the image
`gcr.io/syllogi-ci/e2e-nomos-syllogi:latest`. This image can be generated by the
Nomos make target `make image-e2e-syllogi`, which generates the image and
uploads it to gcr.io/syllogi-ci. This should be regenerated if you change the
test in syllogi.sh.

The result of the test can be viewed in Syllogi's testgrid
[here](https://testgrid.corp.google.com/syllogi-periodic#cluster-create-ipam-privatereg)

To run the test locally without syllogi:

*   Download and apply the latest stable operator according to installation
    instructions. The test assumes the operator is running.
*   Generate the test image by making `image-e2e-syllogi`.
*   Run the test:

    ```
    docker run --rm -i -v $HOME:/host -e KUBECONFIG=/host/.kube/config \
      -e REPORT_DIR=/host -u root gcr.io/syllogi-ci/e2e-nomos-syllogi:latest
    ```
